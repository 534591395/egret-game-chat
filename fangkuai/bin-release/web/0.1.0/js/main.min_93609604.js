var __reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);n.prototype=t.prototype,e.prototype=new n},__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,s){function a(e){try{h(i.next(e))}catch(t){s(t)}}function o(e){try{h(i["throw"](e))}catch(t){s(t)}}function h(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(a,o)}h((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,s&&(a=s[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(s,n[1])).done)return a;switch(s=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,s=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){h.label=n[1];break}if(6===n[0]&&h.label<a[1]){h.label=a[1],a=n;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(n);break}a[2]&&h.ops.pop(),h.trys.pop();continue}n=t.call(e,h)}catch(i){n=[6,i],s=0}finally{r=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,s,a,o,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o},AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,n){function i(i){t.call(n,i,e)}if(RES.hasRes(e)){var r=RES.getRes(e);r?i(r):RES.getResAsync(e,i,this)}else RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.onProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.nextShapeIndex=0,t.index=0,t.timeNum=0,t.timeMax=300,t.time=0,t}return __extends(t,e),t.prototype.createChildren=function(){e.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(e){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var t=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",t),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(e){console.log(e)})},t.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.loadResource()];case 1:return e.sent(),this.createGameScene(),[2]}})})},t.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),e=new LoadingUI,this.stage.addChild(e),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,this.loadTheme()];case 2:return n.sent(),[4,RES.loadGroup("preload",0,e)];case 3:return n.sent(),this.stage.removeChild(e),[3,5];case 4:return t=n.sent(),console.error(t),[3,5];case 5:return[2]}})})},t.prototype.loadTheme=function(){var e=this;return new Promise(function(t,n){var i=new eui.Theme("resource/default.thm.json",e.stage);i.addEventListener(eui.UIEvent.COMPLETE,function(){t()},e)})},t.prototype.createGameScene=function(){this.pannelUI=new Pannel,this.addChild(this.pannelUI),this.restartUI=new Restart,this.addChild(this.restartUI),this.shapeList=[[[0,-1],[-1,1],[0,0],[0,1]],[[0,-1],[1,1],[0,0],[0,1]],[[0,0],[-1,0],[0,1],[0,-1]],[[-1,-1],[0,-1],[0,0],[1,0]],[[0,-1],[1,-1],[-1,0],[0,0]],[[0,-1],[1,-1],[0,0],[1,0]],[[0,-1],[0,0],[0,1],[0,2]]],this.poolList=[],this.pannelUI.addEventListener(MainEvent.Left,this.translateAction,this),this.pannelUI.addEventListener(MainEvent.Right,this.translateAction,this),this.pannelUI.addEventListener(MainEvent.RotateShape,this.rotateShape,this),this.restartUI.addEventListener(MainEvent.Restart,this.start,this)},t.prototype.start=function(){this.score=0,this.changeScore(this.score),this.removeChild(this.restartUI),this.clearShape(this.pannelUI.scrollBox),this.clearNextShape(),this.isParse=!1,this.nextShapeIndex=this.index=0,this.createMatrix(),this.createNewShape()},t.prototype.translateAction=function(e){"左移"===e.type?this.translateXShape(-1):"右移"===e.type&&this.translateXShape(1)},t.prototype.rotateShape=function(){if(5!==this.nowShape.shapeIndex){for(var e=this.nowShape.data,t=[],n=0;n<e.length;n++)t.push([e[n][1],-e[n][0]]);this.nowShape.data=t;var i=this.checkXBoundary();1===Math.abs(i)?this.translateXShape(-i):0===this.checkXBoundary()&&(this.clearShape(this.pannelUI.scrollBox,this.nowShape.index),this.drawShape())}},t.prototype.translateXShape=function(e){0===this.checkXBoundary(e)&&(this.nowShape.x+=t.Gridsize*e,this.clearShape(this.pannelUI.scrollBox,this.nowShape.index),this.drawShape())},t.prototype.getGrid=function(){var e;return e=this.poolList.length?this.poolList.pop():Util.createBitmapByName("rect_png")},t.prototype.destroyGrid=function(e,t){t.removeChild(e),this.poolList.push(e)},t.prototype.createMatrix=function(){this.grids=[];for(var e=0;e<this.pannelUI.scrollBox.height/t.Gridsize;e++){this.grids[e]=[];for(var n=0;n<this.pannelUI.scrollBox.width/t.Gridsize;n++)this.grids[e][n]=!1}},t.prototype.createNewShape=function(){this.nowShape={x:this.pannelUI.scrollBox.width/2,y:-40,shapeIndex:this.nextShapeIndex,index:this.index,data:JSON.parse(JSON.stringify(this.shapeList[this.nextShapeIndex]))},this.index++,this.nextShapeIndex=Math.floor(Math.random()*this.shapeList.length);var e={x:40,y:40,index:0,data:JSON.parse(JSON.stringify(this.shapeList[this.nextShapeIndex]))};this.clearNextShape(),this.drawShape(e,this.pannelUI.nextShapeBox),egret.startTick(this.translateYShape,this)},t.prototype.clearNextShape=function(){this.clearShape(this.pannelUI.nextShapeBox,0)},t.prototype.clearShape=function(e,t){for(var n,i=this.getGridFromLayer(e,t);i.length;)n=i.shift(),this.destroyGrid(n,e)},t.prototype.getGridFromLayer=function(e,t){for(var n=[],i=0;i<e.numChildren;i++){var r=e.getChildAt(i);r&&("undefined"==typeof t?r.name.indexOf("grid")>-1&&n.push(r):r.name==="grid_"+t&&n.push(r))}return n},t.prototype.drawShape=function(e,t){for(var n=e||this.nowShape,i=t||this.pannelUI.scrollBox,r=this.transitionCoordinate(n.data,n.x,n.y),s=0;s<r.length;s++){var a=this.getGrid();a.x=r[s][0],a.y=r[s][1],a.name="grid_"+n.index,i.addChild(a)}},t.prototype.transitionCoordinate=function(e,n,i){for(var r=[],s=0;s<e.length;s++)r.push([t.Gridsize*e[s][0]+n,t.Gridsize*e[s][1]+i]);return r},t.prototype.translateYShape=function(e){var n=e,i=this.time,r=n-i;if(this.timeNum+=r,this.timeNum>this.timeMax&&(this.timeNum=0,!this.isParse)){var s=this.checkYBoundary();s?(this.clearShape(this.pannelUI.scrollBox,this.nowShape.index),this.nowShape.y+=t.Gridsize,this.drawShape()):(egret.stopTick(this.translateYShape,this),this.drawWall(),this.createNewShape())}return this.time=n,!1},t.prototype.checkYBoundary=function(){for(var e=!0,n=this.transitionCoordinate(this.nowShape.data,this.nowShape.x,this.nowShape.y),i=0;i<n.length;i++){var r=n[i][0]/t.Gridsize,s=n[i][1]/t.Gridsize;if(s===this.grids.length-1){e=!1;break}if("undefined"!=typeof this.grids[s+1]&&this.grids[s+1][r]){-1===s&&this.restart(),e=!1;break}}return e},t.prototype.checkXBoundary=function(e){var n=0,i=this.transitionCoordinate(this.nowShape.data,this.nowShape.x,this.nowShape.y);try{for(var r=0;r<i.length;r++){var s=i[r][0]/t.Gridsize,a=i[r][1]/t.Gridsize;if("undefined"==typeof e&&0>s||-1===e&&0===s){n=-1;break}if("undefined"==typeof e&&s>this.grids[0].length-1||1===e&&s===this.grids[0].length-1){n=1;break}if("undefined"==typeof e&&this.grids[a][s]||-1===e&&this.grids[a][s-1]||1===e&&this.grids[a][s+1]){n=2;break}}}catch(o){console.log(o)}return n},t.prototype.drawWall=function(){var e=this.transitionCoordinate(this.nowShape.data,this.nowShape.x,this.nowShape.y),n=0;try{for(n=0;n<e.length;n++){var i=e[n][1]/t.Gridsize,r=e[n][0]/t.Gridsize;this.grids[i][r]=!0}}catch(s){console.log(s),this.restart()}for(n=0;n<this.grids.length;n++){for(var a=!0,o=0;o<this.grids[n].length;o++)if(!this.grids[n][o]){a=!1;break}if(a){this.changeScore();for(var h=n;h>0;h--)for(var c=0;c<this.grids[n].length;c++)this.grids[h][c]=this.grids[h-1][c]}}this.clearShape(this.pannelUI.scrollBox);for(var l=0;l<this.grids.length;l++)for(var p=0;p<this.grids[l].length;p++)if(this.grids[l][p]){var u=this.getGrid();u.x=p*t.Gridsize,u.y=l*t.Gridsize,this.pannelUI.scrollBox.addChild(u)}},t.prototype.restart=function(){console.log("游戏结束"),this.isParse=!0,egret.stopTick(this.translateYShape,this),this.addChild(this.restartUI)},t.prototype.changeScore=function(e){"undefined"==typeof e?this.score+=1:this.score=e,this.pannelUI.score=this.score},t.Gridsize=20,t}(eui.UILayer);__reflect(Main.prototype,"Main");var MainEvent=function(e){function t(t,n,i,r){void 0===n&&(n=""),void 0===i&&(i=!1),void 0===r&&(r=!1);var s=e.call(this,t,i,r)||this;return s._resName="",s._resName=n,s}return __extends(t,e),Object.defineProperty(t.prototype,"resName",{get:function(){return this._resName},enumerable:!0,configurable:!0}),t.Left="左移",t.Right="右移",t.RotateShape="图形翻转",t.Restart="重新开始",t}(egret.Event);__reflect(MainEvent.prototype,"MainEvent");var Pannel=function(e){function t(){var t=e.call(this)||this;t._score=0,t.skinName="resource/skins/Pannel.exml",t.event();var n=new egret.Shape;return n.graphics.lineStyle(2,16777215),n.graphics.beginFill(0,1),n.graphics.drawRect(0,0,t.scrollBox.width,t.scrollBox.height),n.graphics.endFill(),t.scrollBox.addChild(n),t}return __extends(t,e),t.prototype.event=function(){var e=this,t=new MainEvent(MainEvent.Left),n=new MainEvent(MainEvent.Right),i=new MainEvent(MainEvent.RotateShape);this.leftBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.dispatchEvent(t)},this),this.rightBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.dispatchEvent(n)},this),this.rotateShapeBtn.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.dispatchEvent(i)},this)},Object.defineProperty(t.prototype,"score",{get:function(){return this._score},set:function(e){this._score=e,this.scoreLabel.text=this._score+"分"},enumerable:!0,configurable:!0}),t}(eui.Component);__reflect(Pannel.prototype,"Pannel");var DebugPlatform=function(){function e(){}return e.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{nickName:"username"}]})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},e}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var Restart=function(e){function t(){var t=e.call(this)||this;return t.skinName="resource/skins/Restart.exml",t.event(),t}return __extends(t,e),t.prototype.event=function(){var e=this,t=new MainEvent(MainEvent.Restart);this.restart.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){e.dispatchEvent(t)},this)},t}(eui.Component);__reflect(Restart.prototype,"Restart");var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,n,i){function r(e){t.call(i,e)}function s(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),n.call(i))}var a=this;if("undefined"!=typeof generateEUI)egret.callLater(function(){t.call(i,generateEUI)},this);else if("undefined"!=typeof generateEUI2)RES.getResByUrl("resource/gameEui.json",function(e,n){window.JSONParseClass.setData(e),egret.callLater(function(){t.call(i,generateEUI2)},a)},this,RES.ResourceItem.TYPE_JSON);else if("undefined"!=typeof generateJSON)if(e.indexOf(".exml")>-1){var o=e.split("/");o.pop();var h=o.join("/")+"_EUI.json";generateJSON.paths[e]?egret.callLater(function(){t.call(i,generateJSON.paths[e])},this):RES.getResByUrl(h,function(n){window.JSONParseClass.setData(n),egret.callLater(function(){t.call(i,generateJSON.paths[e])},a)},this,RES.ResourceItem.TYPE_JSON)}else egret.callLater(function(){t.call(i,generateJSON)},this);else RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(e,r,this,RES.ResourceItem.TYPE_TEXT)},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Util=function(){function e(){}return e.createBitmapByName=function(e){var t=new egret.Bitmap,n=RES.getRes(e);return t.texture=n,t},e}();__reflect(Util.prototype,"Util");